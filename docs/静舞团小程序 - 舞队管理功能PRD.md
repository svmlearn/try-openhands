
# 静舞团小程序 - 舞队管理功能PRD

## 1. 产品背景

### 1.1 功能定位
**功能名称：** 舞队管理  
**核心价值：** 为舞队领队和成员提供完整的舞队管理和服务功能  
**使用场景：** 舞队日常管理、成员互动、设备维护、紧急求助  

### 1.2 用户角色定义
- **领队**：舞队创建者和管理者，拥有所有管理权限
- **普通成员**：舞队参与者，拥有基础查看和服务功能
- **访客**：非舞队成员，只能查看公开信息

## 2. 功能需求分析

### 2.1 领队功能需求
**管理类功能：**
- 查看成员列表和基本信息
- 成员管理（移除成员、设某位成员为领队）
- 设备管理（绑定设备、管理使用时段）
- 修改舞队信息（名称、头像、简介等）

**审批类功能：**
- 处理加入队员申请
- 设置加入审批规则

**分享类功能：**
- 获取舞队二维码进行分享邀请

**服务类功能：**
- 扫码报修设备故障

**权限类功能：**
- 转让领队权限给其他成员
- 解散舞队

### 2.2 普通成员功能需求
**参与类功能：**
- 查看舞队基本信息
- 查看成员列表

**分享类功能：**
- 获取舞队二维码进行分享

**服务类功能：**
- 扫码报修设备故障

**权限类功能：**
- 退出舞队

## 3. 页面设计

### 3.1 舞队详情页（主页面）

#### 3.1.1 小程序UI界面设计
```
页面结构：
├── 小程序UI覆盖层（固定顶部88px）
│   ├── 状态栏（44px）：时间 + 电池状态
│   └── 小程序导航栏（44px）：返回按钮 + 页面标题 + 三点菜单
├── 页面内容区（从88px开始）
│   ├── 舞队信息区
│   │   ├── 舞队头像（80x80px圆角）
│   │   ├── 舞队名称
│   │   ├── 舞种标签
│   │   ├── 成员数量和领队信息
│   │   └── 舞队详细信息（成员数、领队、创建时间、活动地点）
│   ├── 快速操作区
│   ├── 舞队简介区（仅显示简介内容）
│   └── 底部导航栏
```

#### 3.1.2 领队看到的界面
```
快速操作区（2×2网格布局）：
├── 📱 舞队二维码（蓝色背景）
├── 🔧 扫码报修（橙色背景）
├── 👥 查看成员（显示"15人"）
└── 🔔 待审批（红色徽章，显示"待审批(3)"）

更多菜单弹窗（5个选项）：
├── 👥 成员管理
├── 🎵 设备管理
├── ✏️ 修改舞队信息
├── 👑 转让领队
└── 🗂️ 解散舞队（红色字体，分隔线上方）
```

#### 3.1.3 普通成员看到的界面
```
快速操作区（2×1布局）：
├── 📱 舞队二维码（蓝色背景）
└── 🔧 扫码报修（橙色背景）

更多菜单弹窗（1个选项）：
└── 🚪 退出舞队（红色字体）
```

### 3.2 设备管理页面（独立页面）

#### 3.2.1 设备管理主页面
```
页面结构：
├── 小程序UI覆盖层（88px）
│   ├── 状态栏：时间 + 电池状态
│   └── 导航栏：返回按钮 + "设备管理" 标题
├── 设备列表区域
│   ├── 设备卡片（每个设备一张卡片）
│   │   ├── 设备头部：设备名称 + 状态标签
│   │   ├── 设备信息：位置、绑定/申请时间、使用时段
│   │   └── 操作按钮：查看使用时段 + 解绑/取消申请
│   └── 空状态提示（无设备时显示）
└── 固定底部按钮："绑定新设备"（橙色）
```

#### 3.2.2 设备管理核心功能

**扫码绑定流程：**
```
1. 点击"绑定新设备" → 弹出扫码弹窗
2. 扫描设备二维码（模拟扫描）
3. 获取设备信息 → 跳转时间段选择页面
4. 基于预设开关机模版选择时间段
5. 提交申请 → 等待管理员审核
```

**查看使用时段：**
```
功能变更：从"编辑时段"改为"查看使用时段"
- 只读模式展示舞队已申请的时间段
- 不可编辑，仅查看功能
- 展示格式：周几 + 具体时间
```

**设备占用校验：**
```
在申请新设备时：
- 显示设备预设的开关机模版时间
- 已被其他舞队占用的时间段显示灰色
- 显示占用方信息："已被XX舞队占用"
- 复选框禁用，不可选择
```

### 3.3 设备开关机模版系统

#### 3.3.1 开关机模版数据结构
```javascript
设备模版示例：
{
  'A003': {
    name: '音响设备 - A003',
    location: '文化广场中区',
    schedule: [
      { id: 'mon_morning', day: '周一', time: '07:00-09:00', occupied: false },
      { id: 'mon_late', day: '周一', time: '09:30-11:00', occupied: true, occupiedBy: '阳光舞队' },
      { id: 'tue_evening', day: '周二', time: '19:00-21:00', occupied: false },
      // ... 更多预设时间段
    ]
  }
}
```

#### 3.3.2 时间段选择界面
```
弹窗结构：
├── 弹窗标题："选择使用时间段"
├── 提示文字："从设备开放时间中选择（灰色表示已被占用）"
├── 时间段列表
│   ├── 复选框（可用时间段）
│   ├── 禁用复选框（占用时间段）
│   ├── 时间显示：周几 + 时间范围
│   └── 占用提示："已被XX舞队占用"
└── 操作按钮：取消 + 提交申请
```

#### 3.3.3 设备状态管理
```
设备状态类型：
├── 已激活（绿色）：设备申请已通过，正常使用中
├── 待激活（黄色）：设备申请已提交，等待管理员审核
└── 已解绑：设备已从舞队移除

操作权限：
├── 已激活设备：查看使用时段 + 解绑设备
└── 待激活设备：查看使用时段 + 取消申请
```

#### 3.3.4 数据分离设计
```
数据结构分离：
├── deviceTemplates：设备开放时间模版（后台管理设置）
├── teamSchedules：舞队已申请的时间段记录
└── deviceApplications：设备申请审核状态记录

优势：
├── 模版与申请数据独立管理
├── 便于动态更新设备开放时间
├── 支持批量时间段操作
└── 便于统计和分析使用情况
```

## 4. 交互设计

### 4.1 页面跳转逻辑
```
舞队详情页 → 各功能页面：
├── 点击[舞队二维码] → 舞队二维码页面
├── 点击[扫码报修] → 扫码报修页面
├── 点击[查看成员] → 成员列表页面（显示成员数）
├── 点击[待审批] → 待审批页面（红色徽章提示）
└── 点击更多菜单（三点） → 显示角色对应弹窗

更多菜单跳转（领队）：
├── 成员管理 → 成员管理页面
├── 设备管理 → device-management.html（独立页面）
├── 修改舞队信息 → 舞队编辑页面
├── 转让领队 → 转让领队页面
└── 解散舞队 → 解散确认弹窗

更多菜单跳转（成员）：
└── 退出舞队 → 退出确认弹窗
```

### 4.2 关键交互流程

#### 4.2.1 设备绑定申请流程
```
1. 点击"绑定新设备"按钮
2. 弹出扫码弹窗，申请相机权限
3. 扫描设备二维码（模拟扫描2秒）
4. 获取设备信息，弹出时间段选择弹窗
5. 显示设备预设的开关机模版时间
6. 校验并显示占用状态：
   - 可选时间段：正常复选框
   - 占用时间段：灰色禁用，显示占用方
7. 用户选择可用时间段（至少选一个）
8. 点击"提交申请"，验证选择
9. 生成新设备卡片，状态为"待激活"
10. 显示申请成功提示
```

#### 4.2.2 查看使用时段流程
```
1. 点击设备卡片的"查看使用时段"按钮
2. 弹出查看弹窗，显示舞队已申请的时间段
3. 只读模式展示，格式：周几 + 时间范围
4. 如无申请时间段，显示"暂无申请的时间段"
5. 点击"关闭"或弹窗外部关闭弹窗
```

#### 4.2.3 设备状态管理流程
```
设备状态变更：
├── 新申请 → 待激活状态（黄色标签）
├── 管理员审核通过 → 已激活状态（绿色标签）
├── 用户主动解绑 → 从列表移除
└── 用户取消申请 → 从列表移除

交互反馈：
├── 点击操作按钮显示确认弹窗
├── 操作成功显示toast提示
└── 长时间操作显示loading状态
```

### 4.3 设备申请校验逻辑

#### 4.3.1 时间段占用校验
```javascript
// 检查时间段是否被占用
function checkTimeSlotOccupied(deviceId, slotId) {
  const template = deviceTemplates[deviceId];
  const slot = template.schedule.find(s => s.id === slotId);
  return slot ? slot.occupied : false;
}

// 生成时间段选择界面
function generateScheduleOptions(deviceId) {
  const template = deviceTemplates[deviceId];
  return template.schedule.map(slot => ({
    id: slot.id,
    display: `${slot.day} ${slot.time}`,
    occupied: slot.occupied,
    occupiedBy: slot.occupiedBy,
    disabled: slot.occupied
  }));
}
```

#### 4.3.2 申请提交验证
```javascript
// 验证用户选择
function validateScheduleSelection(selectedSlots) {
  if (selectedSlots.length === 0) {
    alert('请至少选择一个时间段');
    return false;
  }
  
  // 检查是否选择了被占用的时间段
  const invalidSlots = selectedSlots.filter(slot => slot.occupied);
  if (invalidSlots.length > 0) {
    alert('选择的时间段中包含已被占用的时段');
    return false;
  }
  
  return true;
}
```

#### 4.3.3 设备状态控制
```javascript
// 根据设备状态显示不同操作按钮
function getDeviceActions(deviceStatus) {
  switch(deviceStatus) {
    case 'active':
      return ['查看使用时段', '解绑设备'];
    case 'pending':
      return ['查看使用时段', '取消申请'];
    default:
      return [];
  }
}
```

## 5. 数据结构

### 5.1 设备模版数据结构
```json
{
  "deviceTemplates": {
    "A003": {
      "name": "音响设备 - A003",
      "location": "文化广场中区",
      "schedule": [
        {
          "id": "mon_morning",
          "day": "周一",
          "time": "07:00-09:00",
          "occupied": false
        },
        {
          "id": "mon_late",
          "day": "周一", 
          "time": "09:30-11:00",
          "occupied": true,
          "occupiedBy": "阳光舞队"
        }
      ]
    }
  }
}
```

### 5.2 舞队申请时间段数据结构
```json
{
  "teamSchedules": {
    "A001": [
      {
        "day": "周二",
        "time": "19:00-21:00"
      },
      {
        "day": "周四", 
        "time": "19:00-21:00"
      }
    ]
  }
}
```

### 5.3 设备申请记录数据结构
```json
{
  "deviceApplications": [
    {
      "applicationId": "申请ID",
      "teamId": "舞队ID",
      "deviceId": "设备ID",
      "deviceName": "音响设备 - A003",
      "location": "文化广场中区",
      "requestedSchedule": [
        {
          "day": "周一",
          "time": "07:00-09:00"
        }
      ],
      "status": "pending", // pending, approved, rejected
      "appliedAt": "2024-01-20",
      "processedAt": null,
      "processedBy": null
    }
  ]
}
```

### 5.4 设备卡片显示数据结构
```json
{
  "deviceCards": [
    {
      "deviceId": "A001",
      "name": "音响设备 - A001",
      "location": "文化广场东区",
      "status": "active", // active, pending
      "bindTime": "2024-01-15",
      "scheduleDisplay": "每周二、四、六 19:00-21:00",
      "actions": ["查看使用时段", "解绑设备"]
    }
  ]
}
```

## 6. 接口需求

### 6.1 设备管理相关接口
```
GET /api/teams/:teamId/devices - 获取舞队绑定的设备列表
POST /api/teams/:teamId/devices/apply - 申请绑定设备
DELETE /api/teams/:teamId/devices/:deviceId - 解绑设备
PUT /api/teams/:teamId/devices/:deviceId/cancel - 取消设备申请
```

### 6.2 设备模版相关接口
```
GET /api/devices/:deviceId/template - 获取设备开关机模版
GET /api/devices/:deviceId/info - 扫码获取设备基本信息
GET /api/devices/:deviceId/schedule - 获取设备占用时间段
```

### 6.3 时间段管理相关接口
```
GET /api/teams/:teamId/devices/:deviceId/schedule - 获取舞队申请的时间段
POST /api/teams/:teamId/devices/:deviceId/schedule - 提交时间段申请
PUT /api/teams/:teamId/devices/:deviceId/schedule - 修改申请的时间段
```

### 6.4 设备状态管理接口
```
GET /api/admin/devices/applications - 管理员获取设备申请列表
PUT /api/admin/devices/applications/:applicationId/approve - 审核通过设备申请
PUT /api/admin/devices/applications/:applicationId/reject - 拒绝设备申请
```

## 7. 异常处理

### 7.1 网络异常
- 页面加载失败时显示重试按钮
- 操作提交失败时保留用户输入数据
- 图片加载失败时显示默认图片

### 7.2 权限异常
- 非舞队成员访问时显示加入提示
- 普通成员尝试管理操作时显示权限不足
- 相机权限被拒绝时提供手动输入选项

### 7.3 数据异常
- 待审批数量为0时隐藏徽章
- 成员列表为空时显示邀请引导
- 设备未绑定时显示绑定提示

## 8. 用户体验优化

### 8.1 加载性能
- 舞队详情页首屏渲染时间 < 2秒
- 图片采用懒加载和压缩
- 成员列表支持分页加载

### 8.2 操作反馈
- 所有按钮点击有视觉反馈
- 长时间操作显示加载状态
- 操作成功/失败给予明确提示

### 8.3 用户引导
- 新创建舞队时显示功能介绍
- 重要功能提供操作提示
- 空状态页面提供操作引导

## 9. 数据埋点（暂缓实施）

### 9.1 设备管理使用统计
- 设备绑定申请频率
- 时间段选择偏好分析
- 设备解绑原因统计

### 9.2 交互行为分析
- 扫码成功率统计
- 弹窗关闭行为分析
- 操作完成率监控

### 9.3 业务指标监控
- 设备申请审核通过率
- 设备使用时长统计
- 舞队设备配置分布

**注：数据埋点功能按需求暂缓实施，专注核心功能体验优化**

## 10. 测试要点

### 10.1 功能测试
- 不同角色看到的功能差异
- 权限控制是否生效
- 数据状态更新是否及时

### 10.2 兼容性测试
- 不同机型的扫码功能
- 图片上传和显示效果
- 网络异常情况处理

### 10.3 用户体验测试
- 中老年用户操作便利性
- 紧急情况下的操作效率
- 功能发现和理解程度

## 11. 重构要点说明

### 11.1 架构变更
- **移除独立管理页面**：删除team-management.html，功能整合到舞队详情页
- **小程序UI适配**：88px顶部覆盖层（状态栏44px + 导航栏44px）
- **角色权限区分**：领队与普通成员看到不同的功能和菜单

### 11.2 设备管理重新设计
- **核心逻辑变更**："编辑时段" → "查看使用时段"（只读模式）
- **开关机模版**：基于后台预设的时间模版进行申请
- **占用校验**：实时显示其他舞队占用情况，灰色禁用
- **状态管理**：待激活 → 已激活的审核流程

### 11.3 用户体验优化
- **适老化设计**：大字体、高对比度、简化操作流程
- **功能聚焦**：移除复杂信息展示，只保留核心功能
- **交互反馈**：完整的loading、success、error状态提示
- **数据分离**：模版数据与申请数据独立管理，便于扩展
